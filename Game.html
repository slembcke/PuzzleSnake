<html>
	<head>
		<title>Game</title>
	</head>
	<body>
		<style>
			#tiles {
				rx=0.5;
				ry=0.5;
			}
		</style>
		<svg id="svg" width="320" height="320">
			<g id="board">
				<rect x="-100" y="-100" width="200" height="200" fill="#eeeeee"/>
				<g id="tiles">
				</g>
				<polyline id="polyline" fill="none" stroke="lightblue"
					stroke-width="0.8" stroke-linecap="round" stroke-linejoin="round"/>
				<g id="head">
					<circle cx="0.25" cy="0.25" r="0.075" fill="darkblue"/>
					<circle cx="0.25" cy="-0.25" r="0.075" fill="darkblue"/>
					<!--<polygon fill="darkblue" points="0,0.25 0.25,0 0,-0.25" />-->
				</g>
			</g>
		</svg>
		
		<script>
			SVGNS = "http://www.w3.org/2000/svg";
			puzzle = {
				size: 5,
				
				tiles: [
					[1,1,1,0,0],
					[0,1,0,0,0],
					[0,0,0,1,0],
					[0,0,0,0,0],
					[0,0,0,0,0],
				],
			};
			
			
			Output = document.getElementById("output");
			
			{
				// Setup scale matrix.
				var svg = document.getElementById("svg");
				var size = puzzle.size;
				var w = svg.width.baseVal.value;
				var h = svg.height.baseVal.value;
				var sx = w/size;
				var sy = h/size;
				
				var board = document.getElementById("board");
				board.setAttribute("transform", "matrix("+(sx)+", 0, 0, "+(-sy)+", "+(sx/2)+", "+(h - sy/2)+")");
			}
			
			Tiles = document.getElementById("tiles");
			
			function AddTile(x, y){
				var bevel = 0.1;
				var inset = 0.1;
				
				var s = 1.0 - 2.0*inset;
				var hs = 0.5*s;
				
				var rect = document.createElementNS(SVGNS, "rect");
				rect.x.baseVal.value = -hs;
				rect.y.baseVal.value = -hs;
				rect.width.baseVal.value = s;
				rect.height.baseVal.value = s;
				rect.rx.baseVal.value = bevel;
				rect.ry.baseVal.value = bevel;
				rect.setAttribute("fill", "darkgrey");
				rect.setAttribute("transform", "matrix(1, 0, 0, 1, " + x + ", "+ y + ")");
				Tiles.appendChild(rect);
			}
			
			for(var y=0; y<puzzle.size; y++){
				for(var x=0; x<puzzle.size; x++){
					if(puzzle.tiles[y][x]) AddTile(x, y);
				}
			}
			
			function Snake(x, y){
				this.head = [1, 0];
				this.verts = [[x, y], [x, y]];
			}
			
			Snake.prototype.draw = function(){
				var polyline = document.getElementById("polyline");
				polyline.setAttribute("points", this.verts.join(" "));
				
				var c = this.head[0], s = this.head[1];
				var x = this.verts[0][0], y = this.verts[0][1];
				var head = document.getElementById("head");
				head.setAttribute("transform", "matrix("+c+", "+s+", "+s+", "+c+", "+x+", "+y+")")
			}
			
			Snake.prototype.pushVert = function(v, animationCompleted){
				console.log(v);
				var x0 = this.verts[0][0], y0 = this.verts[0][1];
				var x1 = v[0], y1 = v[1];
				
				var dx = x1 - x0, dy = y1 - y0;
				var dist = Math.max(Math.abs(dx), Math.abs(dy));
				this.head = [dx/dist, dy/dist];
				
				var delay = 1.0/60.0;
				var speed = 2.0;
				var t = 0.0;
				function animate(snake){
					// TODO better time based animation here.
					t = Math.min(1.0, t + speed*delay/dist);
					
					snake.verts[0] = [x0 + t*dx, y0 + t*dy];
					snake.draw();
					if(t < 1.0){
						window.setTimeout(animate, delay, snake);
					} else {
						snake.verts.unshift(v);
						if(animationCompleted) animationCompleted();
					}
				}
				
				animate(this);
			}
			
			var snake = new Snake(3, 3);
			
			snake.draw();
			
			var verts = [
				[0, 1],
				[0, 2],
				[2, 2],
				[2, 1],
				[3, 1],
				[3, 0],
				[4, 0],
				[4, 4],
				[0, 4],
				[0, 3],
//				[3, 3],
			];
			
			function Do(verts){
				var l = verts.length;
				if(l){
					snake.pushVert(verts[l - 1], function(){
						Do(verts.slice(0, l - 1));
					});
				}
			}
			Do(verts);
			
		</script>
	</body>
</html>